---
description: 
globs: 
alwaysApply: false
---
Single-entry main.py
The app must boot exclusively from app/main.py; keep all FastAPI startup hooks there so Cursor’s “Run” button just works.

.env stays local
Never hard-code ALPACA_KEY, database URLs, or OpenAI keys. Load them via pydantic.BaseSettings. Commit a .env.example, ignore real .env.

Pure-Python core
Put all trading math in app/services/rebalance.py with zero FastAPI imports—makes unit tests run instantly.

100 % typed, <10 % noqa
Use mypy --strict. Any # type: ignore needs a comment explaining why. Lint with Ruff; max line = 100.

Red-green testing rule
No PR merges without pytest -q green and at least one property-based test for the aggregator limits.

Turnover cap is sacred
MAX_DAILY_TURNOVER lives in settings.py; any change requires a migration note and Slack poll.

One DB migration per feature
Use Alembic. Every schema change file must start with the Jira ticket ID.

Docker first
Local dev and prod run from the same Dockerfile. If it works in docker compose up, it ships.

Log every order
Every submitted order—and its fills—must hit OrderLog before the HTTP 200 returns.

No silent fails
Wrap external calls in retry(times=3, backoff=2); after final fail raise and let Celery retry. No pass on exceptions.

User the virtual environment at ./.venv